# 敵・衝突・AIに関する設計書 (DESIGN_DOCUMENT_ENEMY.md) 

## 1. 基本思想

敵、弾、その他すべての「ゲーム内オブジェクト」は、破壊や相互作用の可能性を持つエンティティとして扱われる。
本設計の目的は、以下の高度なインタラクションを実現するための、柔軟で拡張可能な構造を定義することである。

*   **動的なAI:** 敵の振る舞い（移動、攻撃パターン）を「状態」として管理し、ダメージや時間経過によって動的に変化させる。
*   **階層構造:** 戦艦と砲台のような、親子関係を持つ敵の実現。
*   **部位破壊:** 巨大な敵の装甲や特定のパーツのみを破壊する。
*   **多彩な出現パターン:** 時間、プレイヤーの位置、特定の条件など、様々なトリガーによる敵の動的生成。
*   **リッチな衝突表現:** オブジェクトの「素材」に基づいた、多彩な衝突エフェクト（火花、爆発、破片など）の実現。

## 2. 新規コンポーネント定義

### 2.1. 基本ステータス

*   **`Health`**: `(current, max)`
    *   役割: エンティティの耐久値を管理する。
*   **`Collidable`**: `(group, radius)`
    *   役割: 円形の当たり判定を持つことを示す。

### 2.2. AIと振る舞い

*   **`AIState`**: `(currentState, states)`
    *   役割: エンティティの現在の振る舞い（AIの状態）を定義する。

### 2.3. 階層構造

*   **`Parent`**: `(entityId, offset)`
    *   役割: 親エンティティのIDを保持する。
*   **`Children`**: `(entityIds = [])`
    *   役割: 子エンティティのIDリストを保持する。

### 2.4. イベントアクション

*   **`OnDeath`**: `(actions = [])`
    *   役割: `Health`が0になった際に実行されるアクションを定義する。
*   **`OnCollision`**: `(actions = [])`
    *   役割: 他のエンティティと衝突した際に実行されるアクションを定義する。

### 2.5. 出現ロジック

*   **`Generator`**: `(config)`
    *   役割: 新しいエンティティを動的に生成する「スポナー」の定義。

### 2.6. 材質とエフェクト

*   **`Material`**: `(type)`
    *   役割: エンティティの「材質」を定義する。（例: 'steel', 'rock'）

## 3. 新規・更新システム定義

*   **`AISystem` (新規):**
    *   責務: `AIState`を持つエンティティを監視する。現在の状態に応じた振る舞いを、他のコンポーネント（例: `Velocity`）に反映させる。`DAMAGE_TAKEN`イベントを購読し、AIの状態を`'damaged'`などに遷移させる。

*   **`SpawningSystem`**:
    *   責務: `Generator`を持つエンティティを監視し、条件に応じて`entityFactory`経由で新しいエンティティを生成する。`SPAWN_ENTITY`イベントを購読し、動的なエンティティ生成にも対応する。

*   **`CollisionSystem`**:
    *   責務: `Collidable`を持つエンティティ同士の衝突を**検知**し、`COLLISION`イベントを**発行する**ことに専念する。衝突後の結果については一切関知しない。

*   **`DamageSystem` (新規):**
    *   責務: `COLLISION`イベントを購読する。イベント内容を解釈し、対象エンティティの`Health`コンポーネントを書き換えることでダメージ処理を実行する。

*   **`EffectSystem` (新規):**
    *   責務: `COLLISION`や`DEATH`といったイベントを購読する。エンティティの`Material`コンポーネントなどに応じて、適切なエフェクト（火花、爆発など）を生成するための`SPAWN_EFFECT`イベントを発行する。

*   **`DeathSystem`**:
    *   責務: `Health`が0以下になったエンティティを探し、`DEATH`イベントを発行する。エンティティの`OnDeath`コンポーネントに定義されたアクション（分裂、アイテムドロップなど）を実行するための、さらなるイベント（`SPAWN_ENTITY`など）を発行することもある。

*   **`HierarchySystem` (新規):**
    *   責務: `Parent`を持つエンティティの`Position`を、親エンティティの`Position`に基づいて更新する。

## 4. 処理フローの例

### 例1：弾が敵に当たり、敵がダメージ状態に移行する

1.  **`CollisionSystem`**が「弾」と「敵」の衝突を検知し、`{ type: 'COLLISION', entities: [bulletId, enemyId] }` というイベントを発行する。
2.  **`DamageSystem`**が`COLLISION`イベントを購読しており、これに反応。弾と敵のペアであることを確認し、敵の`Health`を減らす。
3.  **`EffectSystem`**も`COLLISION`イベントを購読しており、これに反応。敵の`Material`に応じた火花エフェクトを生成する。
4.  **`AISystem`**も`COLLISION`イベントを購読しており、ダメージを受けたことを検知。敵の`AIState.currentState`を `'attacking'` から `'damaged'` に変更する。
5.  次のフレームから、**`AISystem`**は敵の`AIState`が`'damaged'`であると認識し、その振る舞い（例: `movement: "drift_uncontrolled"`）を`Velocity`コンポーネントに適用する。結果、敵は制御を失ったように漂い始める。

### 例2：隕石が破壊され、分裂する

1.  弾が隕石に当たり、`DamageSystem`によって`Health`が0になる。
2.  **`DeathSystem`**が`Health`が0以下の隕石を検知し、`{ type: 'DEATH', entityId: meteorId }` というイベントを発行する。同時に、元の隕石エンティティを削除予約する (`world.markForRemoval`)。
3.  **`DeathSystem`**はさらに、隕石が`OnDeath`コンポーネント（分裂アクションを持つ）を持っていることを確認し、`{ type: 'SPAWN_ENTITY', blueprint: 'small_meteor', count: 3 }` のようなイベントを発行する。
4.  **`SpawningSystem`**が`SPAWN_ENTITY`イベントを購読しており、これに反応。`entityFactory`を使い、3つの小さな隕石エンティティを生成する。
