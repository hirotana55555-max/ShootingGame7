# ゲーム拡張に向けたリファクタリング＆実装計画書（REFACTORING_PLAN2.md）
*最終更新日: 2025年10月01日*

## 1. 概要

本計画書は、ゲームの拡張性、特に敵AIや動的なゲームオブジェクトの多様性を向上させるための、基盤整備と新機能実装のロードマップを定義する。
過去の「コンポーネント初期化方式の近代化」リファクタリングの成功を受け、次のステップとして「中央集権的なエンティティ設定管理システム」の導入を最優先目標とする。

## 2. 全体ロードマップ

開発は以下のフェーズに分けて段階的に進める。各ステップでは、動作確認を徹底し、安定性を確保しながら進むことを原則とする。

---

### **フェーズ0: 基盤整備 (完了)**

-   **ステップ1: コンポーネントの分析とルール策定**
    -   [✅ **完了**] 関連設計: -
-   **ステップ2: 全コンポーネントのコンストラクタをオブジェクト形式に統一**
    -   [✅ **完了**] 関連設計: `DESIGN_DOCUMENT.md`
-   **ステップ3: `entityFactory.js` の呼び出し元を新形式に統一**
    -   [✅ **完了**] 関連設計: -
-   **ステップ4: 成果の文書化と設計思想書の更新**
    -   [✅ **完了**] 関連設計: `REFACTORING_PLAN.md`

---

### **フェーズ1: 中央設定管理**

-   **ステップ5: `EntityConfigs.js` を作成し、`asteroid` の定義を記述**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT_ENEMY.md`
-   **ステップ6: `entityFactory.js` を `createEntity(world, type)` に全面改修**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT_ENEMY.md`
-   **ステップ7: `SpawningSystem` 等の呼び出し元を `createEntity` に修正**
    -   [🔲 **未着手**] 関連設計: -

---

### **フェーズ2: AI基礎**

-   **ステップ8: `AIState` コンポーネントを作成**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT_ENEMY.md`
-   **ステップ9: `AISystem` を作成（まずは状態のログ出力から）**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT_ENEMY.md`
-   **ステップ10: `EntityConfigs.js` に `fighter` を追加し、出現テストを行う**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT_ENEMY.md`

---

### **フェーズ3: 高度な機能**

-   **ステップ11: `Parent`, `Children` コンポーネントと `HierarchySystem` を実装**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT_ENEMY.md`
-   **ステップ12: `mothership` と `gun_turret` を定義し、階層構造をテスト**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT_ENEMY.md`
-   **ステップ13: 部位破壊 (`Material`, `OnDeath` 拡張) の実装**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT_ENEMY.md`

---

### **フェーズ4: イベント駆動アーキテクチャへの移行**

-   **ステップ14: `World.publish` を `World.emit` にリネーム**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT.md`
    -   *目的: 設計書と実装の用語を統一し、一貫性を確保する。*
-   **ステップ15: `InputSystem` から `SHOOT_REQUEST` イベントを発行するよう変更**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT.md`
    -   *目的: ユーザー入力という「事実」をイベントとして発行し、射撃ロジックを分離する第一歩。*
-   **ステップ16: `ShootingSystem` をイベント駆動に変更**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT.md`
    -   *目的: `SHOOT_REQUEST` を購読し、弾を生成する責務に特化させる。`entityFactory` への依存を排除。*
-   **ステップ17: `CollisionSystem` から `COLLISION_DETECTED` イベントを発行するよう変更**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT.md`
    -   *目的: 衝突という「事実」をイベント化し、ダメージ計算や死亡処理のロジックを分離する。*
-   **ステップ18: `DamageSystem`, `DeathSystem` をイベント駆動に変更**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT.md`
    -   *目的: `COLLISION_DETECTED` を購読し、それぞれの責務（ダメージ計算、エンティティ削除）を実行するようにする。*

---

## 3. 完了済みタスクの詳細 (フェーズ0)

### 3.1. 目的
プロジェクト初期に定義されたコンポーネントの初期化方式（例: `new Health(3)`）は、引数の意味が不明瞭で、将来的な拡張性に乏しいという課題があった。これを全てのコンポーネントでオブジェクト形式（例: `new Health({ value: 3 })`）に統一し、可読性・保守性・一貫性を向上させた。

### 3.2. 実施プロセス
安全かつ確実に移行を進めるため、コンポーネントごとに以下の手順を繰り返す体系的なアプローチを採用した。

1.  **互換レイヤーの実装:** 対象コンポーネントに旧形式と新形式の両方を受け付ける互換コードと、旧形式を検知するデバッグ機能を実装。
2.  **警告の可視化:** `DebugSystem.js` を改修し、旧形式の使用をリアルタイムで画面に表示。
3.  **呼び出し元の修正:** 画面の警告を元に、プロジェクト内の旧形式呼び出しを全て新形式に修正。
4.  **最終確認:** 警告の消滅と、IDEの全体検索機能による静的解析で、旧形式の呼び出しが残存していないことを確認。
5.  **クリーンナップ:** 対象コンポーネントと `DebugSystem.js` から、一時的な互換・デバッグコードを完全に削除。

### 3.3. 成果
`Health`, `Team`, `Collidable`, `Lifetime`, `Controllable`, `Bullet` の全てのコンポーネントの初期化方式を統一。これにより、プロジェクトのコンポーネントレイヤーは、設計思想書に沿った、より堅牢で保守性の高い状態に進化した。

---
*この計画書は、プロジェクトの進捗に応じて随時更新されるものとする。*
