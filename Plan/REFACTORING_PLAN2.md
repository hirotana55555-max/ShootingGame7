# ゲーム拡張に向けたリファクタリング＆実装計画書（REFACTORING_PLAN2.md）
*最終更新日: 2025年10月02日*

## 1. 概要

本計画書は、ゲームの拡張性、特に敵AIや動的なゲームオブジェクトの多様性を向上させるための、基盤整備と新機能実装のロードマップを定義する。
過去の「コンポーネント初期化方式の近代化」リファクタリングの成功を受け、次のステップとして「中央集権的なエンティティ設定管理システム」の導入を最優先目標とする。

## 2. 全体ロードマップ

開発は以下のフェーズに分けて段階的に進める。各ステップでは、動作確認を徹底し、安定性を確保しながら進むことを原則とする。

---

### **フェーズ0: 基盤整備 (完了)**

-   **ステップ1: コンポーネントの分析とルール策定**
    -   [✅ **完了**] 関連設計: -
-   **ステップ2: 全コンポーネントのコンストラクタをオブジェクト形式に統一**
    -   [✅ **完了**] 関連設計: `DESIGN_DOCUMENT.md`
-   **ステップ3: `entityFactory.js` の呼び出し元を新形式に統一**
    -   [✅ **完了**] 関連設計: -
-   **ステップ4: 成果の文書化と設計思想書の更新**
    -   [✅ **完了**] 関連設計: `REFACTORING_PLAN.md`

---

### **フェーズ1: 中央設定管理**

-   **ステップ5: `EntityConfigs.js` を作成し、`asteroid` の定義を記述**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT_ENEMY.md`
-   **ステップ6: `entityFactory.js` を `createEntity(world, type)` に全面改修**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT_ENEMY.md`
-   **ステップ7: `SpawningSystem` 等の呼び出し元を `createEntity` に修正**
    -   [🔲 **未着手**] 関連設計: -

---

### **フェーズ2: AI基礎**

-   **ステップ8: `AIState` コンポーネントを作成**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT_ENEMY.md`
-   **ステップ9: `AISystem` を作成（まずは状態のログ出力から）**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT_ENEMY.md`
-   **ステップ10: `EntityConfigs.js` に `fighter` を追加し、出現テストを行う**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT_ENEMY.md`

---

### **フェーズ3: 高度な機能**

-   **ステップ11: `Parent`, `Children` コンポーネントと `HierarchySystem` を実装**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT_ENEMY.md`
-   **ステップ12: `mothership` と `gun_turret` を定義し、階層構造をテスト**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT_ENEMY.md`
-   **ステップ13: 部位破壊 (`Material`, `OnDeath` 拡張) の実装**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT_ENEMY.md`

---

### **フェーズ4: イベント駆動アーキテクチャへの移行**

-   **ステップ14: `World.publish` を `World.emit` にリネーム**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT.md`
    -   *目的: 設計書と実装の用語を統一し、一貫性を確保する。*
-   **ステップ15: `InputSystem` から `SHOOT_REQUEST` イベントを発行するよう変更**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT.md`
    -   *目的: ユーザー入力という「事実」をイベントとして発行し、射撃ロジックを分離する第一歩。*
-   **ステップ16: `ShootingSystem` をイベント駆動に変更**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT.md`
    -   *目的: `SHOOT_REQUEST` を購読し、弾を生成する責務に特化させる。`entityFactory` への依存を排除。*
-   **ステップ17: `CollisionSystem` から `COLLISION_DETECTED` イベントを発行するよう変更**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT.md`
    -   *目的: 衝突という「事実」をイベント化し、ダメージ計算や死亡処理のロジックを分離する。*
-   **ステップ18: `DamageSystem`, `DeathSystem` をイベント駆動に変更**
    -   [🔲 **未着手**] 関連設計: `DESIGN_DOCUMENT.md`
    -   *目的: `COLLISION_DETECTED` を購読し、それぞれの責務（ダメージ計算、エンティティ削除）を実行するようにする。*

---

### **フェーズ5: パフォーマンス最適化 (未着手)**

-   **ステップ1: デバッグシステムの動的インポート化**
    -   [ ] **未着手** 関連設計: `DEBUGGING_POLICY.md`

#### 5.1. 目的
リリースビルドの初期ロード時間とメモリフットプリントを最小化し、将来の大量パーティクル実装に備える。`DebugConfig.ENABLED: false` 時に、デバッグ関連のコードが一切メモリにロードされない状態を完全に実現する。

#### 5.2. 実施計画
1.  **`main.js` の改修:**
    -   ファイル先頭のデバッグ関連の静的`import`文をすべて削除する。
    -   代わりに、「トップレベルawait」を利用し、`if (DebugConfig.ENABLED)` ブロック内で動的`import()`を用いて、デバッグ用モジュールを条件付きで非同期に読み込むように変更する。
2.  **動作検証:**
    -   `ENABLED: true` 時に、すべてのデバッグ機能（ポーズ、コマ送り、各種表示）が正常に動作することを確認する。
    -   `ENABLED: false` 時に、ブラウザの開発者ツール（ネットワークタブ）で、デバッグ用ファイルが一切読み込まれていないことを確認する。
3.  **関連ドキュメントの更新:**
    -   `DEBUGGING_POLICY.md` の「4.3. main.js への登録方法」を、完了した動的インポートの実装に合わせて更新する。


---

## 3. 完了済みタスクの詳細 (フェーズ0)

### 3.1. 目的
プロジェクト初期に定義されたコンポーネントの初期化方式（例: `new Health(3)`）は、引数の意味が不明瞭で、将来的な拡張性に乏しいという課題があった。これを全てのコンポーネントでオブジェクト形式（例: `new Health({ value: 3 })`）に統一し、可読性・保守性・一貫性を向上させた。

### 3.2. 実施プロセス
安全かつ確実に移行を進めるため、コンポーネントごとに以下の手順を繰り返す体系的なアプローチを採用した。

1.  **互換レイヤーの実装:** 対象コンポーネントに旧形式と新形式の両方を受け付ける互換コードと、旧形式を検知するデバッグ機能を実装。
2.  **警告の可視化:** `DebugSystem.js` を改修し、旧形式の使用をリアルタイムで画面に表示。
3.  **呼び出し元の修正:** 画面の警告を元に、プロジェクト内の旧形式呼び出しを全て新形式に修正。
4.  **最終確認:** 警告の消滅と、IDEの全体検索機能による静的解析で、旧形式の呼び出しが残存していないことを確認。
5.  **クリーンナップ:** 対象コンポーネントと `DebugSystem.js` から、一時的な互換・デバッグコードを完全に削除。

### 3.3. 成果
`Health`, `Team`, `Collidable`, `Lifetime`, `Controllable`, `Bullet` の全てのコンポーネントの初期化方式を統一。これにより、プロジェクトのコンポーネントレイヤーは、設計思想書に沿った、より堅牢で保守性の高い状態に進化した。

---

### **フェーズ4: 高度デバッグ基盤の構築 (完了)**

-   **ステップ1: ポーズ＆コマ送り機能の実装**
    -   [✅ **完了**] 関連設計: `DESIGN_DOCUMENT.md`, `DEBUGGING_POLICY.md` (新設想定)

#### 4.1. 目的
リファクタリング作業の品質と効率を飛躍的に向上させるため、実行中のゲームを任意に停止・観察できるデバッグ基盤を構築する。特に、高速で移動する弾丸や、複雑なAIの挙動をフレーム単位で分析可能にすることを目標とした。

#### 4.2. 実施プロセス
コンソールが使用不可という厳しい制約下で、以下の段階的なアプローチを採用し、堅牢なデバッグ環境を構築した。

1.  **キー入力問題の特定と解決:**
    *   ブラウザIDE特有の「フォーカス問題」によりキー入力がゲームに届かない根本原因を、仮説と検証を繰り返すことで特定。
    *   `GameCanvas.tsx` に `tabindex` と `focus()` を適用し、Canvasが確実にキー入力を受け取れるように改修。

2.  **デバッグシステムの分離設計:**
    *   `main.js` のゲームループを再設計。「常に更新するシステム（入力・制御）」と「ポーズ中に停止するシステム（ゲームロジック・描画）」に分離。
    *   これにより、ポーズ中もキー入力を受け付け、ポーズ解除やコマ送りが可能になるアーキテクチャを確立した。

3.  **関連モジュールの新設と改修:**
    *   **新設:**
        *   `DebugControlSystem.js`: ポーズ/コマ送りの状態を管理する頭脳。
        *   `DebugVector.js`: リファクタリング前後など、ベクトル値を比較表示するための汎用デバッグコンポーネント。
    *   **改修:**
        *   `DebugConfig.js`: キー割り当てを一元管理し、将来の変更を容易に。
        *   `InputSystem.js`: `preventDefault()` を適切に呼び出し、ブラウザのデフォルト動作を抑制。
        *   `DebugSystem.js`: `KEYS` の状態を可視化し、入力の疎通確認に貢献。

#### 4.3. 成果
-   **ポーズ機能 (`F8`):** ゲームの時間を完全に停止させ、オブジェクトの配置や状態を静的に観察できるようになった。
-   **コマ送り機能 (`F9`):** 1フレーム単位でゲームを進行させ、衝突判定やAIの意思決定プロセスなどを詳細に追跡できるようになった。
-   これにより、今後のリファクタリングや新機能実装において、**動作保証を伴う安全な開発**が可能となった。

---

### 3.2. 弾の速度計算ロジックの責務分離 (フェーズ1)

#### 3.2.1. 目的
ECSの「関心の分離」の原則に則り、`entityFactory.js` が担っていた物理計算（弾の初速ベクトル計算）の責務を、本来持つべき `ShootingSystem.js` に移管する。これにより、`entityFactory.js` は純粋な「エンティティ組み立て工場」としての役割に専念でき、コードの責務が明確化され、保守性が向上した。

#### 3.2.2. 実施プロセス
我々が構築した高度デバッグ基盤（ポーズ＆コマ送り機能）を最大限に活用し、以下の安全な手順でリファクタリングを遂行した。

1.  **現状の可視化:** `entityFactory.js` の旧計算ロジックの結果を、`DebugVector` コンポーネント（ラベル: 'OLD'）として画面に表示。
2.  **ロジックの移植:**
    *   `entityFactory.js` から速度計算ロジックを削除し、引数で `vx`, `vy` を受け取るように改修。
    *   `ShootingSystem.js` に速度計算ロジックを移植し、計算結果を `createBullet` に渡すように改修。
3.  **新旧比較による動作保証:** 移植後の `ShootingSystem.js` で計算した新ロジックの結果を、`DebugVector` コンポーネント（ラベル: 'NEW'）として画面に表示。ポーズ機能を用いて、`[OLD]` と `[NEW]` の値が完全に一致することを目視で確認し、ロジックの等価性を証明した。
4.  **クリーンアップ:** 動作保証の完了後、検証のために使用した `DebugVector` 関連のコードを、`ShootingSystem.js`, `entityFactory.js`, `DebugSystem.js` から完全に除去し、リファクタリングを完了させた。

#### 3.2.3. 成果
`entityFactory.js` と `ShootingSystem.js` の責務が完全に分離された。これにより、将来的に弾の種類や発射ロジックが複雑化しても、変更箇所が `ShootingSystem.js` に限定されるため、拡張性と保守性が大幅に向上した。

---

*この計画書は、プロジェクトの進捗に応じて随時更新されるものとする。*
