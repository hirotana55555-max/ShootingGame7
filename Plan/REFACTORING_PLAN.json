{
  "manifest_version": "1.0",
  "last_updated": "2025-11-29",
  "system_name": "Dynamic Error Monitor (DEM) - Integrated Server Edition",
  "description": "ゲームクライアントで発生したエラーを自動収集・分析し、開発者に通知するための統合エラー監視システム。旧スタンドアロンサーバーの機能を、Next.jsの本番ビルドに対応した、TypeScriptベースの、内部ライブラリとして、再設計したものである。",
  "philosophy": "エラーは、単に、修正されるべき、『バグ』では、なく、システムの、健全性を、測り、未来の、アーキテクチャを、改善するための、貴重な、『データ』である。",
  "architecture": {
    "description": "このシステムの、コンポーネントは、複数の、ディレクトリに、またがって、存在している。",
    "components": [
      {
        "id": "endpoint",
        "name": "【司令塔】APIエンドポイント",
        "path": "app/api/collect/route.ts",
        "role": "クライアントからの、全エラー報告を受信する、唯一の、窓口。各内部ライブラリを、呼び出し、エラー処理の、フロー全体を、制御する。"
      },
      {
        "id": "internal_libs",
        "name": "【兵器庫】内部ライブラリ",
        "path": "app/api/_lib/",
        "role": "APIルートの、ロジックを、実現するための、TypeScriptモジュール群。Next.jsの、ルーティング対象外 (`_lib`) となっている。",
        "modules": [
          {
            "file": "parser.ts",
            "role": "スタックトレースの、解析官"
          },
          {
            "file": "resolver.ts",
            "role": "エラー発生源の、特定官"
          },
          {
            "file": "db.ts",
            "role": "データベースへの、記録官"
          }
        ]
      },
      {
        "id": "primary_db",
        "name": "【心臓部】エラーデータベース",
        "path": "DynamicErrorMonitor/database/errors.db",
        "role": "収集・解析された、全エラー情報を、格納する、SQLiteデータベース。"
      },
      {
        "id": "knowledge_source",
        "name": "【知識源】静的インデックス",
        "path": "Project_Cognize/database/static_index.db",
        "role": "resolver.tsが、エラー発生箇所を、特定するために、参照する、ソースコードの、インデックス。"
      },
      {
        "id": "visualization",
        "name": "【監視モニター】エラー可視化",
        "tool": "GlitchTip (Sentry互換)",
        "config_files": [
          "sentry.client.config.ts",
          "sentry.server.config.ts",
          "sentry.edge.config.ts",
          "next.config.js"
        ]
      }
    ]
  },
  "technical_debt": {
    "id": "cleanup_targets",
    "description": "以下の、ファイルは、現在、使用されておらず、新システムへの、完全移行後に、削除されるべき、旧コンポーネントである。",
    "files": [
      "DynamicErrorMonitor/src/collector/parser.js",
      "DynamicErrorMonitor/src/reverse-lookup/resolver.js",
      "DynamicErrorMonitor/src/collector/db.js",
      "public/error-snippet.js",
      "DynamicErrorMonitor/client/error-snippet.js"
    ]
  },
  "quick_start": {
    "environment": "開発環境",
    "steps": [
      {
        "step": 1,
        "name": "依存インストール",
        "commands": [
          "npm install",
          "npm install better-sqlite3 @types/better-sqlite3"
        ]
      },
      {
        "step": 2,
        "name": "環境変数設定",
        "description": ".envファイルに、以下の、変数が、設定されていることを、確認する。",
        "variables": [
          "ERRORS_DB_PATH",
          "STATIC_INDEX_DB_PATH",
          "ENABLE_GLITCHTIP",
          "GLITCHTIP_DSN"
        ]
      },
      {
        "step": 3,
        "name": "開発サーバー起動",
        "command": "npm run dev"
      },
      {
        "step": 4,
        "name": "本番ビルド＆起動",
        "commands": [
          "npm run build",
          "npm run start"
        ]
      }
    ]
  },
  "phases": [
    {
      "phase_id": 10,
      "name": "【測量士の視力矯正】indexer.js 分類バグ修正と環境復旧",
      "priority": 1,
      "status": "COMPLETED",
      "objective": "indexer.jsがshared_patterns.jsのルールを正しく解釈できない致命的なバグを修正し、Project Cognizeの自己認識能力を完全に回復させる。",
      "current_situation": "環境構築の問題を解決し、`indexer.js`の`node_modules`除外ロジックの追加と、それが機能することを確認した。",
      "action_plan": [
        {
          "step": 10.1,
          "description": "【完了】classifyFile関数の正規表現ロジックを、micromatchライブラリを使用する方式に置き換える。",
          "status": "COMPLETED"
        },
        {
          "step": 10.2,
          "description": "【完了】Node.js V20環境への移行、`build-essential`導入、`better-sqlite3`の再ビルド、`npm install --force`の実行。",
          "status": "COMPLETED"
        },
        {
          "step": 10.3,
          "description": "【完了】`classifyFile`関数に`node_modules`を最優先で除外するロジックを追加し、TOON生成時に依存ファイルが完全に除外されることを実証。",
          "status": "COMPLETED"
        },
        {
          "step": 10.4,
          "description": "【完了】全ログをクリーンアップし、`indexer.js`と`generate_toon.js`を順次実行し、システムが期待通り動作することを最終確認した。",
          "status": "COMPLETED"
        }
      ],
      "related_bug_id": "BUG-008, BUG-009"
    },
    {
      "phase_id": 8,
      "name": "【コネクテッド・ワールド - 連携システムの、完全統合】",
      "priority": 2,
      "status": "IN_PROGRESS",
      "objective": "indexer.js, query_index.js, cognize_indexer.yml の、3システム間の、矛盾を、完全に、解消し、期待通りに、連携する、堅牢な、CI/CDパイプラインを、再構築する。",
      "action_plan": [
        {
          "step": 8.1,
          "description": "【完了】TOON構造の確認を完了し、自作コードのみがインデックス化されたことを確認した。",
          "status": "COMPLETED"
        },
        {
          "step": 8.2,
          "description": "【次作業】`Project_Cognize`配下のスクリプトが、GitHub Actionsで自動実行されるよう、`.github/workflows/cognize_indexer.yml`を、最新の実行コマンドで更新・コミットする。",
          "status": "PENDING"
        }
      ]
    }
  ],
  "governance": {
    "id": "GOV-01",
    "title": "統治原則：LLMエージェントが、遵守すべき、絶対的、ルール",
    "prohibitions": [
      {
        "rule": "AGENT_MODE_PROHIBITED",
        "description": "このファイルは、分析と、理解のための、情報共有であり、タスク実行の、直接的な、指示ではない。性急な、エージェントモードへの、切り替えを、禁止する。"
      },
      {
        "rule": "NO_DESTRUCTIVE_CHANGES",
        "description": "破壊的改変は、厳禁とする。提案の、前に、必ず、現状を、徹底的に、分析し、仮説を、実証すること。"
      }
    ],
    "architectural_constitution": {
      "id": "AP-01",
      "principle": "Single Source of Truth for Project Scope",
      "description": "プロジェクトの、『自作コード』の、範囲や、各ツールの、振る舞いを、定義する、全ての、設定は、ただ、一つの、ファイル `/Project_Cognize/config/shared_patterns.js` に、集約される。これを、当プロジェクトの、『憲法』と、定める。",
      "llm_instruction": {
        "level": "CRITICAL",
        "summary": "【最重要警告】いかなる、理由があろうとも、この、『憲法』に、反する、ような、コード（例：スクリプト内への、パスの、ハードコード）を、生成してはならない。プロジェクトの、範囲を、変更したい場合は、まず、`shared_patterns.js`の、修正を、提案せよ。"
      }
    }
  },
  "workflow_overview": {
    "id": "WF-01",
    "title": "データ駆動型・自己認識ワークフロー",
    "description": "Project Cognizeは、個々の、ツールが、連携し、プロジェクト自身が、自分を、分析・記述する、エコシステムを、形成する。",
    "data_flow": [
      {
        "step": 1,
        "actor": "indexer.js",
        "action": "憲法(`shared_patterns.js`)に、基づき、全ファイルを、スキャンし、AST解析を実行する。",
        "output": "ファイル構造、シンボル、依存関係、インスタンス等の、詳細な、メタデータ。",
        "destination": "static_index.db (主データベース) / static_index.jsonl (ログ)"
      },
      {
        "step": 2,
        "actor": "generate_toon.js",
        "action": "最新の、`static_index.db`を、読み込み、プロジェクトの、完全な、階層構造を、生成する。",
        "output": "TOON (Tree-Oriented Object Notation) 形式の、構造化データ。",
        "destination": "project_structure_toon.json"
      },
      {
        "step": 3,
        "actor": "generate_prompt.ts",
        "action": "目的の、タスクと、最新の、`project_structure_toon.json`、及び、各種テンプレートを、組み合わせる。",
        "output": "LLMの、思考を、正確に、ガイドするための、コンテキスト情報が、豊富に、埋め込まれた、実行プロンプト。",
        "destination": "LLM Agent (e.g., GLIA)"
      }
    ]
  },
  "core_components": [
    {
      "id": "config_file",
      "file_name": "config/shared_patterns.js",
      "main_description": "【憲法】プロジェクトの、範囲と、振る舞いを、定義する、唯一の、設定ファイル。全ての、ツールの、動作は、この、ファイルに、従う。"
    },
    {
      "id": "indexer",
      "file_name": "scripts/indexer.js",
      "main_description": "【測量士】プロジェクトの、静的解析を、行い、全ての、情報を、データベース化する、中核ツール。"
    },
    {
      "id": "toon_generator",
      "file_name": "scripts/generate_toon.js",
      "main_description": "【地図製作者】データベース情報に基づき、LLMが、解釈可能な、プロジェクトの、階層構造マップ（TOON）を、生成する。"
    },
    {
      "id": "prompt_generator",
      "file_name": "scripts/generate_prompt.ts",
      "main_description": "【作戦立案官】TOONマップと、テンプレートを、元に、LLMへの、具体的な、指示プロンプトを、生成する。"
    },
    {
      "id": "query_tool",
      "file_name": "scripts/query_index.js",
      "main_description": "【司書】生成された、データベースの、内容を、人間が、照会・確認するための、CLIツール。"
    }
  ],
  "automation": {
    "id": "github_actions",
    "file_path": ".github/workflows/cognize_indexer.yml",
    "main_description": "この、エコシステムは、GitHub Actionsによって、自動化されている。`main`ブランチへの、変更を、トリガーに、`indexer.js`が、自動実行され、データベースが、常に、最新に、保たれる。",
    "llm_instruction": {
      "level": "CRITICAL",
      "summary": "【最重要】`Project_Cognize`配下の、スクリプトの、ファイル名や、コマンドオプションを、変更する際は、必ず、この、自動化ワークフロー (`cognize_indexer.yml`) も、同時に、修正しなければ、CI/CDパイプラインが、完全に、破綻する。"
    }
  },
  "tool_reference": {
    "id": "TOOL-REF-01",
    "tool_name": "query_index.js",
    "description": "静的解析データベースを照会するためのCLIツール。LLMは、プロジェクトに関する情報を得るために、これらのコマンドを積極的に使用すべきである。",
    "commands": [
      {
        "name": "schema",
        "description": "データベースの現在のテーブル構造とマイグレーション履歴を表示する。",
        "usage": "node Project_Cognize/scripts/query_index.js schema",
        "purpose": "DBの状態やスキーマ変更の確認に使用する。"
      },
      {
        "name": "list",
        "description": "プロジェクト内のファイルを一覧表示する。",
        "usage": "node Project_Cognize/scripts/query_index.js list [オプション]",
        "options": [
          {
            "name": "--self-made-only",
            "description": "shared_patterns.jsの定義に基づき、『自作コード』と判定されたファイルのみを表示する。"
          }
        ],
        "purpose": "特定の種類のファイル群をリストアップする際に使用する。まず厳密検索を試し、見つからなければ--fuzzyを検討する。"
      },
      {
        "name": "search",
        "description": "ファイルパスに対してパターン検索を実行する。",
        "usage": "node Project_Cognize/scripts/query_index.js search <パターン> [オプション]",
        "options": [
          {
            "name": "--fuzzy",
            "description": "部分一致による曖昧検索を有効にする。デフォルトは、より高速で正確な厳密検索。"
          }
        ],
        "purpose": "特定のキーワードを含むファイルを探す際に使用する。まず厳密検索を試し、見つからなければ--fuzzyを検討する。"
      },
      {
        "name": "stats",
        "description": "プロジェクト全体の包括的な統計情報を表示する。",
        "usage": "node Project_Cognize/scripts/query_index.js stats [オプション]",
        "options": [
          {
            "name": "--by-category",
            "description": "自作コードを『component』『game-core』などのカテゴリ別に集計した、より詳細な統計を表示する。"
          }
        ],
        "purpose": "プロジェクトの全体像（規模、言語構成、自作コード率など）を素早く把握するために使用する。"
      },
      {
        "name": "deps",
        "description": "指定されたファイルが、どのファイルに依存し（import）、どのファイルから依存されているか（imported by）を表示する。",
        "usage": "node Project_Cognize/scripts/query_index.js deps <ファイルパス>",
        "options": [],
        "purpose": "コード変更時の影響範囲を調査するために不可欠なコマンド。"
      },
      {
        "name": "instances",
        "description": "指定されたクラスが、プロジェクト内のどこでインスタンス化（`new`）されているかを検索する。",
        "usage": "node Project_Cognize/scripts/query_index.js instances <クラス名> [オプション]",
        "options": [
          {
            "name": "--show-builtins",
            "description": "デフォルトで除外されているJavaScriptのビルトインクラス（RegExp, Date等）も検索対象に含める。"
          }
        ],
        "purpose": "特定のクラスの使われ方を調査したり、リファクタリングの影響範囲を特定したりする際に使用する。"
      }
    ]
  }
}