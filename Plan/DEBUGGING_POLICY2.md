### 提案する最終版 `DEBUGGING_POLICY2.md`（POLICY1上位互換）

# デバッグ・開発支援機能管理ポリシー
*最終更新日: 2025年10月02日（プッシュ時の時刻に更新を推奨）*

## 1. 目的と基本方針

### 1.1. 目的
本プロジェクトは、ブラウザベースのIDE（BlitzIDE）およびメモリ制約の厳しい環境（Samsung Galaxy Fold 6）での開発を前提としている。そのため、本ポリシーは以下を実現することを目的とする。

- 開発中の**メモリ圧迫やクラッシュを防ぐ**ための暫定措置を安全に導入する。
- **AIによるコード上書きリスク**に対応し、開発用コードが消失しない仕組みを確立する。
- ゲーム本体の**コード肥大化を回避**し、責務の分離を徹底する。
- リリース時に**1つのフラグ操作で全開発機能を無効化**し、パフォーマンスへの影響をゼロにする。

### 1.2. 基本方針
本プロジェクトにおけるデバッグは、バグを修正するだけの場当たり的な作業ではない。**システムの健全性を計測し、設計の正しさを証明するための、積極的かつ不可欠なエンジニアリング活動**である。すべてのデバッグ機能は以下の原則に従う。

1.  **本体からの完全分離:**
    - すべての開発・デバッグ用コードは、`/game/debug` ディレクトリ以下に集約する。
    - `/game/systems` や `/game/core` など本体ロジック内に**一切混入させてはならない**。
2.  **フラグによる一元管理:**
    - `game/debug/DebugConfig.js` に `ENABLED` フラグを設け、すべての機能の有効/無効を制御する。
3.  **パフォーマンス影響ゼロの保証:**
    - `ENABLED: false` 時は、開発用システムはインスタンス化されず、メモリにもロードされず、実行時のパフォーマンスに全く影響を与えない状態を目指す。
4.  **ECS準拠とAI耐性の確保:**
    - デバッグ機能自体もECSアーキテクチャで実装する。
    - `main.js` への登録は条件分岐で行い、AIによる安易なコード上書きから保護する。

---

## 2. 現状のデバッグ機能と課題 (コードレビュー)

### 2.1. 実装済みの機能 (実績)
- **デバッグHUD:** マウス右クリックで、エンティティ数、FPS、入力キーなどの情報を表示/非表示。
- **ポーズ機能 (`F8`):** ゲーム時間を完全に停止させ、オブジェクトの状態を静的に観察可能。
- **コマ送り機能 (`F9`):** 1フレーム単位でゲームを進行させ、衝突やAIの挙動を詳細に追跡可能。

### 2.2. 現在の課題 (実態)
度重なる不具合修正の過程で、当初のクリーンな分離設計から一部逸脱・劣化した箇所が観測される。

- **課題1: 描画ロジックの混入**
    - **実態:** `RenderSystem` 内に、デバッグ用の当たり判定（コリジョン範囲）を描画するロジックが残存している。
    - **問題点:** 本来 `DebugSystem` が担うべき責務が本体システムに漏れ出しており、分離原則に違反している。
- **課題2: デバッグシステムの不完全な分離**
    - **実態:** `main.js` のゲームループ内で、`DebugSystem` が他のゲームロジックシステムと同列に扱われている箇所がある。
    - **問題点:** ポーズ中にデバッグ表示が更新されないなど、意図しない挙動の原因となる可能性がある。

---

## 3. 将来の目標とロードマップ

### 3.1. 短期目標: 設計逸脱の修正
- **目的:** 現在の課題を解決し、デバッグシステムを再びクリーンな状態に戻す。
- **ステップ:**
    1. `RenderSystem` から当たり判定の描画ロジックを完全に削除する。
    2. そのロジックを `DebugSystem` に移管し、`DebugConfig` フラグでON/OFFを制御できるようにする。
    3. `main.js` のゲームループを改修し、`DebugSystem` の更新処理を、他の全システムの描画が完了した**最後のステップ**として明確に分離・実行する。

### 3.2. 長期目標: パフォーマンスの完全最適化
- **目的:** `ENABLED: false` 時に、デバッグ関連のコードがメモリに一切ロードされない状態を**完全に**実現する。
- **ステップ (理想形):**
    1. **動的インポートの導入:** `main.js` のファイル先頭にあるデバッグ関連の静的 `import` 文をすべて削除する。
    2. **条件付きロード:** `if (DebugConfig.ENABLED)` ブロック内で、動的 `import()` を用いてデバッグ用モジュールを条件付きで非同期に読み込むように変更する。
    3. **動作検証:** `ENABLED: false` 時に、ブラウザの開発者ツール（ネットワークタブ）で、デバッグ用ファイルが一切読み込まれていないことを確認する。
    - *この課題は `REFACTORING_PLAN.md` にも記載済みである。*

---

## 4. 実装ルールとノウハウ集

### 4.1. `main.js` への登録方法
デバッグシステムは、その役割に応じて**実行順序を厳密に制御する**必要がある。以下の構造は、ポーズ＆コマ送り機能の正常動作に不可欠であり、AIによる安易な変更を禁ずる。

```js
// game/core/main.js

// --- 1. ファイル先頭でインポート (現状は静的) ---
import { DebugConfig } from '../debug/DebugConfig.js';
// ... (DebugControlSystem, DebugSystemなど)

export function startGame(canvas) {
  // ...
  // グループA: 常に更新 (入力・制御)
  if (DebugConfig.ENABLED) {
    alwaysUpdateSystems.push(new DebugControlSystem(world));
  }

  // グループB: ポーズ中に停止 (ゲームロジック)
  if (DebugConfig.ENABLED) {
    gameLogicSystems.push(new OffscreenCleanupSystem(world));
  }

  // グループC: 描画の最後 (デバッグ表示)
  if (DebugConfig.ENABLED) {
    debugSystem = new DebugSystem(world);
  }
  // ... (ゲームループ内の分離実行ロジック) ...
}
```

### 4.2. ノウハウ1: 高度デバッグ基盤の構築プロセス
- **目的:** リファクタリングの品質と効率を飛躍的に向上させるため、実行中のゲームを任意に停止・観察できるデバッグ基盤を構築した。
- **実施プロセス:**
    1.  **キー入力問題の特定と解決:** ブラウザIDE特有の「フォーカス問題」を、仮説と検証を通じて特定。`GameCanvas.tsx` に `tabIndex` と `focus()` を適用し、Canvasが確実にキー入力を受け取れるように改修した。
    2.  **デバッグシステムの分離設計:** `main.js` のゲームループを「常に更新するシステム」と「ポーズ中に停止するシステム」に再設計。これにより、ポーズ中もキー入力を受け付け、ポーズ解除やコマ送りが可能なアーキテクチャを確立した。
    3.  **関連モジュールの新設と改修:** `DebugControlSystem.js`, `DebugVector.js` を新設し、`DebugConfig.js`, `InputSystem.js`, `DebugSystem.js` を改修した。

### 4.3. ノウハウ2: 動作保証を伴う安全なリファクタリング手法
- **目的:** ECSの「関心の分離」に則り、`entityFactory.js` の物理計算責務を `ShootingSystem.js` に安全に移管した。
- **実施プロセス:**
    1.  **現状の可視化:** `DebugVector` を使い、旧計算結果を `[OLD]` として画面に表示。
    2.  **ロジックの移植:** `entityFactory.js` からロジックを削除し、`ShootingSystem.js` に移植。
    3.  **新旧比較による動作保証:** 新ロジックの結果を `[NEW]` として表示。**ポーズ機能とコマ送り機能を駆使**し、`[OLD]` と `[NEW]` の値が全フレームで完全に一致することを目視で確認し、ロジックの等価性を証明した。
    4.  **クリーンアップ:** 検証用の `DebugVector` 関連コードを完全に除去した。

---
