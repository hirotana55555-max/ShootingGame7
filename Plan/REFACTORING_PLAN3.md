### 📋 `REFACTORING_PLAN3.md` 統合・更新分析レポート
`REFACTORING_PLAN.md` と `REFACTORING_PLAN2.md` を統合


# ゲーム拡張に向けたリファクタリング＆実装計画書
*最終更新日: 2025年10月02日16:19*

## 1. 概要
本計画書は、ゲームの拡張性、保守性、安定性を向上させるための、基盤整備と新機能実装のロードマップを定義する。プロジェクトの健全性を維持するため、すべての変更は段階的に、かつ動作保証を伴いながら進めることを原則とする。

---

## 2. 完了済みタスク (実績)

### ✅ **フェーズA: ECS基盤の近代化**
- **目的:** プロジェクト初期の古い設計を、設計思想書に準拠した堅牢な形式に統一した。
- **成果:**
    - 全コンポーネントのコンストラクタをオブジェクト形式 (`new Component({ key: value })`) に統一。
    - `entityFactory.js` の呼び出し元を新形式に統一。
    - これにより、コードの可読性と保守性が大幅に向上し、将来のデータ駆動設計への移行準備が整った。

### ✅ **フェーズB: 高度デバッグ基盤の構築**
- **目的:** コンソールが使用不可という制約下で、リファクタリングの品質と効率を飛躍的に向上させるデバッグ基盤を構築した。
- **成果:**
    - **ポーズ機能 (`F8`):** ゲーム時間を完全に停止させ、オブジェクトの状態を静的に観察可能に。
    - **コマ送り機能 (`F9`):** 1フレーム単位でゲームを進行させ、衝突やAIの挙動を詳細に追跡可能に。
    - この基盤があったからこそ、後続の安全なリファクタリングが実現できた。

### ✅ **フェーズC: 責務分離リファクタリング**
- **目的:** ECSの「関心の分離」の原則に基づき、各モジュールの責務を明確化した。
- **成果:**
    - **弾の速度計算ロジックの責務分離:** `entityFactory.js` が担っていた物理計算を `ShootingSystem.js` に移管。`entityFactory.js` は純粋な「組み立て工場」となった。
    - **キーボード操作不具合の修正:** 複数のファイルにまたがる複雑な原因（Canvasのフォーカス問題）を、仮説と検証を通じて特定し、根本的に解決した。

---

## 3. 現在の課題と次のステップ

### 🆘 **最優先課題: 連射制御の実装**
- **現状:** スペースバーを押し続けると、意図しない高速連射が発生する。
- **原因:** `ShootingSystem` が「キーが押されている状態」を検知しており、「キーが押された瞬間」を検知できていないため。
- **次のアクション:**
    1. `InputState` コンポーネントに「このフレームで新たに押されたキー」を記録するプロパティを追加する。
    2. `InputSystem` を改修し、この新プロパティを毎フレーム更新するようにする。
    3. `ShootingSystem` が、この新プロパティを参照して弾丸を発射するように修正する。

---

## 4. 将来的なロードマップ (未着手)

### **フェーズD: データ駆動設計への移行**
- **目的:** エンティティの定義をコード (`entityFactory.js`) から外部データファイルに分離し、メンテナンス性と拡張性を飛躍的に向上させる。敵キャラクターやアイテムの追加を容易にする。
- **ステップ:**
    1. `game/blueprints` ディレクトリを新設。
    2. エンティティ定義ファイル（例: `player.js`, `meteor.js`）を作成。形式は動的な値も扱えるJavaScriptモジュール形式を採用。
    3. `entityFactory.js` に、ブループリントからエンティティを生成する汎用的な関数 (`createEntityFromBlueprint`) を実装する。
    4. `main.js` や `SpawningSystem.js` など、既存の `createPlayer` や `createMeteor` の呼び出し元を、新しい汎用関数に置き換える。

### **フェーズE: イベント駆動アーキテクチャの徹底**
- **目的:** システム間の暗黙的な結合（他のシステムのコンポーネントを直接参照する現状）を解消し、より疎結合で再利用性の高いアーキテクチャへ移行する。
- **ステップ:**
    1. `InputSystem` が `SHOOT_REQUEST` イベントを発行するように変更。
    2. `ShootingSystem` が `InputState` を直接見るのをやめ、`SHOOT_REQUEST` イベントを購読するように変更。
    3. `CollisionSystem` が `COLLISION_DETECTED` イベントを発行するように変更。
    4. `DamageSystem` や `DeathSystem` が、このイベントを購読して処理を行うように変更。

### **フェーズF: 高度なゲーム機能の実装**
- **目的:** より複雑で魅力的なゲームプレイを実現する。
- **ステップ:**
    - **AIの実装:** `AIState` コンポーネントと `AISystem` を導入し、敵キャラクターの思考ルーチンを実装する。
    - **親子関係の実装:** `Parent`/`Children` コンポーネントと `HierarchySystem` を導入し、砲台を持つ戦艦のような複合エンティティを実装する。

---

