/home/hiro/development/shooting_game/ShootingGame7/Project_Cognize/scripts

{
  "file_analysis": {
    "file_name": "indexer_v1.3.js",
    "main_description": "Project_Cognizeの中核となる静的解析・インデックス作成ツール。",
    "functional_overview": [
      {
        "id": 1,
        "summary": "全自作コード対応",
        "details": "ゲーム本体 (game/) に加え、3つの開発補助システム (Project_Cognize/, DynamicErrorMonitor/, Project_scanner/) 全てをスキャン対象とする。"
      },
      {
        "id": 2,
        "summary": "ASTによる詳細解析",
        "details": "JavaScript/TypeScriptファイル (.js, .ts) に対して Babel/AST 解析を実行し、シンボル（関数、クラス、変数）、インポート/エクスポート情報、クラスのインスタンス化情報を抽出・記録する。"
      },
      {
        "id": 3,
        "summary": "JSON専用処理",
        "details": ".json ファイルの構造を検証し、サイズ、キーカウント、クリティカルファイル判定（例：refactor_policy.json）などのメタ情報を収集する。"
      },
      {
        "id": 4,
        "summary": "データベース永続化",
        "details": "抽出した全メタデータを高性能な SQLiteデータベース (database/static_index.db) に格納する。依存関係とインスタンス情報専用のテーブルも利用する。"
      },
      {
        "id": 5,
        "summary": "JSONLログ出力",
        "details": "データベースとは別に、解析レコードを JSON Lines形式 (workspace/outputs/static_index.jsonl) で追記ログとして出力する。"
      },
      {
        "id": 6,
        "summary": "差分/フルスキャン対応",
        "details": "デフォルトはGitの差分（git diff HEAD~1）に基づく差分スキャン。オプションで全ファイル強制フルスキャンに切り替え可能。"
      },
      {
        "id": 7,
        "summary": "JSONLローテーション",
        "details": "static_index.jsonl が 50MB を超えた場合、自動的に .gz で圧縮し、アーカイブディレクトリ (workspace/outputs/) に移動する。"
      }
    ],
    "command_options": {
      "execution_example": "node ./Project_Cognize/scripts/indexer_v1.3.js [オプション]",
      "options": [
        {
          "option": "（オプションなし）",
          "meaning": "デフォルト実行",
          "purpose": "変更されたファイルのみをスキャンし、DBとJSONLに書き込む。",
          "llm_instruction": "通常のリファクタリング前の更新に使用します。"
        },
        {
          "option": "--dry-run",
          "meaning": "書き込みなし",
          "purpose": "ファイル解析は実行するが、DBやJSONLファイルへの書き込みは行わない。",
          "llm_instruction": "解析ロジックのテストやデバッグに使用します。"
        },
        {
          "option": "--full-scan",
          "meaning": "全ファイル強制スキャン",
          "purpose": "Gitの差分を無視し、設定された全パターンのファイルを強制的に解析する。",
          "llm_instruction": "DBが壊れた場合や初回の全量取得に使用します。"
        },
        {
          "option": "--verbose",
          "meaning": "詳細ログ出力",
          "purpose": "処理中の各ファイルの状態、デバッグ情報（debugレベルのログ）など、詳細な実行ログを表示する。",
          "llm_instruction": "問題発生時の調査に使用します。"
        }
      ]
    }
  }
}{
  "file_analysis": {
    "file_name": "generate_toon.js",
    "main_description": "SQLiteデータベース (static_index.db) の内容に基づき、プロジェクト全体の階層構造を表現するTOON (Tree-Oriented Object Notation) 形式のJSONファイルを生成するスクリプト。",
    "dependencies": [
      "path",
      "fs",
      "better-sqlite3"
    ],
    "configuration": {
      "PROJECT_ROOT": "スクリプトの2階層上のディレクトリ (../../)",
      "DB_PATH": "../database/static_index.db",
      "OUTPUT_FILE": "../workspace/outputs/project_structure_toon.json"
    },
    "processing_flow": [
      "DB接続確認: 指定されたDB_PATHにファイルが存在するかを確認し、存在しなければエラーで終了する。",
      "データ取得: SQLiteデータベースに読み取り専用で接続する。",
      "SQL実行: 'file_index'テーブルから 'path', 'loc', 'updated_at', 'is_critical' カラムを取得する。'loc'は 'size'、'updated_at'は 'last_modified'、'is_critical'は 'is_indexed' としてエイリアスを付けて取得する。",
      "TOON構造の構築: 取得したファイルリストを反復処理し、再帰的な関数 'addToStructure' を用いて階層構造オブジェクトを構築する。",
      "ノード属性設定: ファイルノードには、拡張子 (ext)、サイズ (sz: 行数 'loc'が入る)、最終更新日時 (mdf)、インデックス済みフラグ (dbi: 'is_critical'のブール値が入る) を設定する。",
      "JSON出力: 最終的なTOONデータにヘッダー情報と統計情報を付加し、指定されたOUTPUT_FILEへ整形されたJSON (null, 2) を書き出す。",
      "後処理: データベース接続を閉じる。"
    ],
    "output_data_structure_fields": {
      "TOON_HEADER": "バージョン、生成日時、ソース情報を含むメタデータ。",
      "statistics": "総ファイル数 (totalFiles) と生成スクリプト名。",
      "structure": "プロジェクトの階層構造を表すツリーオブジェクト。ノードは 'n'(名前), 't'(タイプ: file/directory), 'p'(パス), 'lvl'(レベル) を持つ。"
    },
    "key_functionality": {
      "purpose": "静的インデックス情報（indexer_v1.3.jsで生成されたデータ）を可視化・利用しやすい階層型JSON形式に変換すること。",
      "data_mapping_fix": "DBから取得するカラム名 ('loc', 'updated_at', 'is_critical') を、TOON出力形式のキー名 ('sz', 'mdf', 'dbi') に意図的にマッピングしている点が修正点として強調されている。"
    }
  }
}{
  "toolName": "Cognize Query Tool",
  "version": "v1.3",
  "description": "プロジェクトの静的インデックスデータベース (static_index.db) を照会するためのCLIツール。ファイルメタデータ、シンボル、依存関係、クラスインスタンス化の情報を取得・分析する。",
  "databaseInfo": {
    "type": "SQLite",
    "path": "Project_Cognize/database/static_index.db",
    "tablesUsed": [
      "file_index",
      "file_dependencies",
      "class_instances"
    ]
  },
  "commands": [
    {
      "command": "list",
      "usage": "node Project_Cognize/scripts/query_index.js list",
      "summary": "全ファイル一覧の表示",
      "details": "インデックス化された全ファイルのパス、言語、行数 (LOC)、最終更新日時を一覧表示する。",
      "function": "listAll",
      "requiredArgs": []
    },
    {
      "command": "search",
      "usage": "node Project_Cognize/scripts/query_index.js search <pattern>",
      "summary": "ファイルパスの部分一致検索",
      "details": "ファイルパスに指定された`<pattern>`を含むファイルを検索し、ファイルの情報とファイル内に含まれるシンボル名の一覧を表示する。",
      "function": "search",
      "requiredArgs": [
        {
          "name": "<pattern>",
          "description": "ファイルパスの部分一致検索パターン"
        }
      ]
    },
    {
      "command": "stats",
      "usage": "node Project_Cognize/scripts/query_index.js stats",
      "summary": "プロジェクトの統計情報表示",
      "details": "総ファイル数、総行数、言語別内訳、行数TOP10ファイル、総インスタンス化数、頻繁にインスタンス化されるクラスTOP10を表示する。",
      "function": "stats",
      "requiredArgs": []
    },
    {
      "command": "deps",
      "usage": "node Project_Cognize/scripts/query_index.js deps <file>",
      "summary": "依存関係の表示",
      "details": "指定された`<file>`がインポートしているモジュール (Dependencies) と、そのファイルを使用している他のファイル (Dependents) の一覧を表示する。",
      "function": "showDependencies",
      "requiredArgs": [
        {
          "name": "<file>",
          "description": "依存関係を調査するファイルパス"
        }
      ]
    },
    {
      "command": "instances",
      "usage": "node Project_Cognize/scripts/query_index.js instances <className>",
      "summary": "クラスのインスタンス化箇所検索 (新規機能)",
      "details": "指定された`<className>` (部分一致可) がコード内でインスタンス化されている全箇所を検索し、ファイルパス、行番号、コードスニペット、コンストラクタ引数の詳細情報 (型、値) を含めて表示する。最後にファイルごとの集計サマリーを表示する。",
      "function": "showInstances",
      "requiredArgs": [
        {
          "name": "<className>",
          "description": "インスタンス化を検索するクラス名"
        }
      ]
    }
  ],
  "dependencies": [
    "better-sqlite3",
    "path"
  ]
}{
  "toolName": "JSONLローテーション手動実行スクリプト",
  "version": "1.0",
  "fileName": "ローテーション手動実行用 (ファイル名不明, 例: rotate_jsonl.sh)",
  "language": "Bash Script",
  "description": "静的解析結果を含むJSONLファイル (`static_index.jsonl`) のサイズが10MB以上の場合に、タイムスタンプ付きのgzip圧縮ファイルとしてアーカイブディレクトリに移動し、元のファイルを空にするためのシェルスクリプト。",
  "usage": "直接実行: ./scripts/rotate_jsonl.sh (またはスクリプトのパス)",
  "environmentVariables": {
    "COGNIZE_ROOT": {
      "derivation": "スクリプトの場所から2階層上のディレクトリ (`..`) の絶対パス",
      "purpose": "プロジェクトのルートパスを特定するために使用"
    }
  },
  "parameters": [],
  "steps": [
    {
      "step": 1,
      "description": "プロジェクトルート (`COGNIZE_ROOT`) とファイルパスの定義",
      "details": "JSONLファイルパス (`static_index.jsonl`) とアーカイブディレクトリ (`workspace/outputs`) を特定する。"
    },
    {
      "step": 2,
      "description": "JSONLファイルの存在確認",
      "details": "ターゲットファイルが存在しない場合、エラーメッセージを出力して終了する。"
    },
    {
      "step": 3,
      "description": "ファイルサイズの確認",
      "details": "`du -m` を使用してファイルサイズをMB単位で取得する。サイズが **10MB未満** の場合、ローテーションをスキップして正常終了する。"
    },
    {
      "step": 4,
      "description": "アーカイブファイルの命名",
      "details": "現在のタイムスタンプ (`%Y%m%d_%H%M%S`) を使用し、`static_index_YYYYMMDD_HHMMSS.jsonl.gz` の形式で新しいファイル名を定義する。"
    },
    {
      "step": 5,
      "description": "ファイルの圧縮とアーカイブ",
      "details": "`gzip -c` コマンドでJSONLファイルを圧縮し、アーカイブファイル (`ARCHIVE_FILE`) にリダイレクトして保存する。元のファイルは変更しない。",
      "command": "gzip -c \"$JSONL_PATH\" > \"$ARCHIVE_FILE\""
    },
    {
      "step": 6,
      "description": "ローテーション（ファイルのクリア）",
      "details": "圧縮が成功した場合 (`$? -eq 0`)、元のJSONLファイル (`static_index.jsonl`) を空にする。",
      "command": "echo \"\" > \"$JSONL_PATH\""
    },
    {
      "step": 7,
      "description": "結果出力",
      "details": "成功/失敗メッセージを出力して終了する。"
    }
  ]
}